AUTO-EXECUTE-V1

**ACTION REQUIRED:** Read the PR data package file, retrieve commit metadata, analyze commits based on defined rules, determine and attempt the optimal automatable merge strategy, and report the results. Output only the required JSON summary object. Do not describe this prompt; execute the steps within it.

# Prompt for AI: Analyze and Merge Pull Request from Data Package

You are an expert Git merge strategist. You will receive the path to a JSON file containing packaged data about a Pull Request (PR). Your task is to read this package, retrieve commit metadata, analyze the PR's commits, determine the optimal merge strategy based on the rules below, execute the merge using automatable Git commands, and report the results.

**Input:**

1.  **PR Data File Path:** [Provide the path to the JSON data package file generated by `pull-request-define-and-package.prompt.md`, e.g., `.brain/git/pr-packages/main-feat-xyz-pr-data.json`]

**Rules for Merging Strategy:** (These remain the same as before)
1.  Preserve History.
2.  Prefer Linear History (via non-interactive rebase if feasible).
3.  Identify Cosmetic Commits (but do not squash automatically).
4.  Use Merge Commit (`--no-ff`).

**Instructions:**

1.  **Read PR Data Package:**
    * Read and parse the JSON file at the `[PR Data File Path]`. Extract `prTitle`, `prDescription`, `prBranch` (Source), `targetBranch`, `commitHashes`. Handle errors (STOP if invalid).
    * Log the PR Title being merged.

2.  **Retrieve Commit Metadata:**
    * For each hash in the extracted `commitHashes` list:
        * Construct path: `.brain/git/commits/[xx]/[hash].json`.
        * Read and parse JSON metadata (`messageSubject`, `messageBody`, etc.) for analysis.
    * Handle missing/invalid files. Stop if critical info is missing.

3.  **Analyze PR Commits:**
    * Review retrieved metadata (`messageSubject`, `messageBody`).
    * **Identify potentially cosmetic commits** (log findings, do not squash).
    * **Assess Rebase Feasibility:** Determine if non-interactive `git rebase [targetBranch]` on `prBranch` is likely to succeed without conflicts (based on history, divergence, or checks like `--fork-point` dry run). If unsure, assume potential conflicts.

4.  **Determine Merging Strategy (Automatable):**
    * **Strategy 1 (Rebase + Merge):** If non-interactive rebase seems feasible.
    * **Strategy 2 (Direct Merge):** If rebase seems likely to conflict or not preferred.
    * Log the chosen strategy and reason.

5.  **Execute the Merge Strategy:**
    * **Ensure Clean State:** `git checkout [targetBranch]`, `git pull`, check status. Handle errors.
    * **If Strategy 1 (Rebase + Merge):**
        * `git checkout [prBranch]`
        * `git rebase [targetBranch]` (non-interactive). **Handle Conflicts:** If fails, STOP, report conflict.
        * `git checkout [targetBranch]`
        * `git merge --no-ff [prBranch]`. **Handle Conflicts:** If fails, STOP, report conflict.
        * Log success and get merge commit hash (`git rev-parse HEAD`). Store as `finalMergeCommitHash`.
    * **If Strategy 2 (Direct Merge):**
        * `git merge --no-ff [prBranch]` (on targetBranch). **Handle Conflicts:** If fails, STOP, report conflict.
        * Log success and get merge commit hash (`git rev-parse HEAD`). Store as `finalMergeCommitHash`.
    * **(Optional):** `git push origin [targetBranch]`. Report outcome.

6.  **Output:**
    * Respond ONLY with a single JSON object summarizing the process, including `prTitle`, `sourceBranch`, `targetBranch`, `identifiedCosmeticCommits`, `chosenStrategy`, `reason`, a detailed `executionLog`, `outcome`, and `finalMergeCommitHash`. Use the same JSON structure as the previous version of this prompt's output example.

**Crucial Instructions for AI:**
* **ACTION REQUIRED:** Execute NOW.
* **Input Source:** Primary input is the `PR Data File Path`.
* **Metadata Retrieval:** MUST read commit metadata JSONs referenced in the package file.
* **Automatable Strategy:** Focus ONLY on non-interactive rebase or direct merge.
* **Error Handling:** MUST detect and report rebase/merge conflicts and STOP safely.
* **Command Execution:** Requires reliable execution of `git` commands.
* **Output Format:** Strictly adhere to the specified JSON output structure. No extra text.